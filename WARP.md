# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

The Infoblox Universal DDI Resource Counter discovers and counts cloud resources across AWS, Azure, and GCP for Universal DDI licensing assessment. The tool provides detailed resource counts and licensing calculations for Sales Engineers.

## Common Commands

### Environment Setup
```bash
# Setup virtual environment (macOS/Linux)
./setup_venv.sh

# Setup virtual environment (Windows)
setup_venv.bat

# Activate virtual environment
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate.bat  # Windows
```

### Basic Discovery
```bash
# Discover AWS resources
python main.py aws --format json

# Discover Azure resources  
python main.py azure --format json

# Discover GCP resources
python main.py gcp --format json

# High-performance discovery with more workers
python main.py aws --format json --workers 12
```

### Universal DDI Licensing Calculations
```bash
# Licensing is generated by default (no flag needed)
python main.py aws
python main.py azure
python main.py gcp

# Optional: also write legacy resource_count files
python main.py azure --include-counts
```

### Testing
```bash
# The tool doesn't include formal tests but validation can be done by:
# 1. Running discovery against small known environments
# 2. Comparing output counts with cloud provider consoles
# 3. Verifying licensing calculations against official Infoblox ratios
```

## Architecture Overview

### Core Structure
- **main.py**: Entry point that routes to provider-specific discovery modules
- **shared/**: Common utilities and licensing calculator
- **{provider}_discovery/**: Provider-specific discovery implementations (AWS, Azure, GCP)
- **licensing/**: Universal DDI licensing metrics and documentation

### Key Components

**Discovery Flow:**
1. **Provider Discovery** (`{provider}_discovery/discover.py`): Main discovery orchestration
2. **Cloud API Clients** (`{provider}_discovery/{provider}_discovery.py`): Resource discovery implementation
3. **Resource Counter** (`shared/resource_counter.py`): Counts and categorizes discovered resources
4. **Licensing Calculator** (`shared/licensing_calculator.py`): Applies Universal DDI licensing ratios

**Configuration:**
- **Base Discovery** (`shared/base_discovery.py`): Abstract base class for all providers
- **Provider Configs** (`{provider}_discovery/config.py`): Provider-specific configuration
- **Constants** (`shared/constants.py`): DDI resource types, licensing ratios, and provider mappings

### Resource Classification

**DDI Objects** (25 per Management Token):
- VPCs, Subnets, DNS Zones, DNS Records
- DHCP ranges, IPAM blocks (where applicable)
- Defined in `DDI_RESOURCE_TYPES` constant

**Active IP Addresses** (13 per Management Token):
- Extracted from resource details using `IP_DETAIL_KEYS`
- De-duplicated across all discovered resources
- Includes private IPs, public IPs, load balancer IPs

**Managed Assets** (3 per Management Token):  
- Compute instances, load balancers, gateways with IP addresses
- Only counted if they have associated IP addresses
- Defined in `ASSET_RESOURCE_TYPES` constant

## Output Files

### Discovery Results
- `{provider}_native_objects_{timestamp}.{format}`: Full resource inventory (with --full)
- `{provider}_resource_count_{timestamp}.{format}`: Resource count summary

### Licensing Results
- `{provider}_universal_ddi_estimator_{timestamp}.csv`: Minimal columns for sizing sheets
- `{provider}_universal_ddi_licensing_{timestamp}.txt`: Human-readable summary
- `{provider}_universal_ddi_proof_{timestamp}.json`: Audit manifest (scope, regions, hashes)
- `{provider}_unknown_resources_{timestamp}.json`: Only when unknown types exist

## Provider-Specific Notes

### AWS
- Uses boto3 for API access
- Requires AWS CLI v2.0.0+ and valid credentials
- Discovers across all enabled regions automatically
- Supports AWS SSO and multiple profiles

### Azure  
- Uses Azure Management SDK
- Requires Azure CLI authentication (`az login`)
- Discovers across all available regions
- Supports service principal authentication

### GCP
- Uses Google Cloud SDK
- Requires gcloud authentication or service account credentials
- Limited region discovery based on `GCP_REGIONS` constant

## Licensing Integration

The Universal DDI licensing calculator (`shared/licensing_calculator.py`) implements the official Infoblox licensing model:

- Based on official documentation in `licensing/Universal DDI Licensing - Universal DDI - Infoblox Documentation Portal.pdf`
- Uses Native Objects ratios: 25 DDI Objects, 13 Active IPs, 3 Managed Assets per Management Token
- Provides CSV and text exports optimized for Sales Engineers
- Includes provider breakdown and official licensing citations

## Development Guidelines

### Adding New Resource Types
1. Update `DDI_RESOURCE_TYPES` or `ASSET_RESOURCE_TYPES` in `shared/constants.py`
2. Implement discovery logic in provider-specific discovery classes
3. Ensure proper IP extraction for assets using `_extract_ips_from_details()`

### Adding New Providers
1. Create `{provider}_discovery/` directory with required modules
2. Implement `{Provider}Discovery` class extending `BaseDiscovery`
3. Add provider choice to `main.py` argument parser
4. Update `SUPPORTED_PROVIDERS` constant

### Modifying Licensing Logic
- Only modify based on official Infoblox documentation updates
- Update licensing ratios in `UniversalDDILicensingCalculator` class
- Ensure changes align with `licensing/metrics.yml` specifications

## Key Files to Understand

1. `main.py`: Entry point and argument parsing
2. `shared/base_discovery.py`: Core discovery patterns and resource formatting
3. `shared/licensing_calculator.py`: Universal DDI licensing calculations
4. `{provider}_discovery/discover.py`: Provider-specific CLI and orchestration
5. `shared/constants.py`: Resource type mappings and licensing ratios