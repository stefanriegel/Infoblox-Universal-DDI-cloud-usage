---
phase: 05-gcp-project-enumeration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - gcp_discovery/discover.py
  - main.py
autonomous: true
requirements: [ENUM-01, ENUM-02, ENUM-03, ENUM-04, ENUM-05, ENUM-06]

must_haves:
  truths:
    - "Running `python main.py gcp` with no --project flag or GOOGLE_CLOUD_PROJECT triggers multi-project enumeration"
    - "Running `python main.py gcp --project my-proj` bypasses enumeration and scans that single project"
    - "Running `python main.py gcp --org-id 123456` scopes enumeration to that org"
    - "Running `python main.py gcp --include-projects 'prod-*'` filters the project list"
    - "Running `python main.py gcp --exclude-projects 'test-*'` excludes matching projects"
    - "The enumerate_gcp_projects() result is stored but Phase 5 still runs single-project discovery for backward compatibility — Phase 6 adds the multi-project iteration"
  artifacts:
    - path: "gcp_discovery/discover.py"
      provides: "CLI argument definitions and enumerate_gcp_projects() call"
      contains: "--project"
    - path: "gcp_discovery/discover.py"
      provides: "Enumeration call wired into main()"
      contains: "enumerate_gcp_projects"
    - path: "main.py"
      provides: "New GCP flags forwarded to gcp_main"
      contains: "gcp_args.project"
  key_links:
    - from: "main.py:main()"
      to: "gcp_discovery/discover.py:main()"
      via: "gcp_args namespace"
      pattern: "gcp_args\\.project"
    - from: "gcp_discovery/discover.py:main()"
      to: "gcp_discovery/config.py:enumerate_gcp_projects()"
      via: "function call with args"
      pattern: "enumerate_gcp_projects"
    - from: "gcp_discovery/discover.py:main()"
      to: "gcp_discovery/config.py:ProjectInfo"
      via: "import and usage"
      pattern: "ProjectInfo"
---

<objective>
Wire the GCP project enumeration into the CLI by adding `--project`, `--org-id`, `--include-projects`, and `--exclude-projects` flags to both `discover.py` and `main.py`, then call `enumerate_gcp_projects()` in `discover.py:main()`. Phase 5 stores the project list but still runs single-project discovery for backward compat — Phase 6 converts to multi-project iteration.

Purpose: Makes the enumeration logic from Plan 01 accessible to users via CLI flags and connects it to the discovery entry point.

Output: Updated `gcp_discovery/discover.py` with new args and enumeration call. Updated `main.py` with forwarded GCP flags.
</objective>

<execution_context>
@/Users/sr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gcp-project-enumeration/05-RESEARCH.md
@.planning/phases/05-gcp-project-enumeration/05-01-SUMMARY.md
@gcp_discovery/discover.py
@main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI flags and wire enumerate_gcp_projects() into discover.py main()</name>
  <files>gcp_discovery/discover.py</files>
  <action>
Modify `gcp_discovery/discover.py`:

1. **Update imports** — Add `enumerate_gcp_projects` and `ProjectInfo` to the import from `.config`:
   ```python
   from .config import GCPConfig, get_all_gcp_regions, get_gcp_credential, enumerate_gcp_projects, ProjectInfo
   ```
   Also add `import os` if not already present (needed for GOOGLE_CLOUD_ORG_ID fallback).

2. **Add new argparse arguments** to the internal parser (the `if args is None:` block), after the existing `--licensing` argument:
   ```python
   parser.add_argument(
       "--project",
       default=None,
       help="Scan a single GCP project (bypasses enumeration). "
            "Overrides GOOGLE_CLOUD_PROJECT env var.",
   )
   parser.add_argument(
       "--org-id",
       default=None,
       help="Scope enumeration to this GCP organization ID. "
            "Overrides GOOGLE_CLOUD_ORG_ID env var.",
   )
   parser.add_argument(
       "--include-projects",
       nargs="+",
       metavar="PATTERN",
       default=None,
       help="Only scan projects matching these glob patterns (e.g. 'prod-*').",
   )
   parser.add_argument(
       "--exclude-projects",
       nargs="+",
       metavar="PATTERN",
       default=None,
       help="Skip projects matching these glob patterns (e.g. 'test-*').",
   )
   ```
   `nargs="+"` requires at least one pattern if the flag is present (per research recommendation).

3. **Replace current single-project flow** in `main()` after credential validation. The current code does:
   ```python
   credentials, project = get_gcp_credential()
   # ... banner ...
   config = GCPConfig(project_id=project, ...)
   ```

   Change the flow to:
   ```python
   # Credential validation first (fail-fast before banner): CRED-02, CRED-03
   credentials, project = get_gcp_credential()

   # Enumerate projects (ENUM-01 through ENUM-06)
   # Resolves org_id from flag or env var
   org_id = getattr(args, "org_id", None) or os.getenv("GOOGLE_CLOUD_ORG_ID")
   projects = enumerate_gcp_projects(
       credentials=credentials,
       adc_project=project,
       project=getattr(args, "project", None),
       org_id=org_id,
       include_patterns=getattr(args, "include_projects", None),
       exclude_patterns=getattr(args, "exclude_projects", None),
   )

   print("GCP Cloud Discovery for Management Token Calculation")
   print("=" * 55)
   print(f"Output format: {args.format.upper()}")
   print(f"Parallel workers: {args.workers}")
   print()
   ```

   Note: The `enumerate_gcp_projects()` call prints the "Found N ACTIVE projects" line and [Skip] lines internally (per locked decision — silent during enumeration unless error or skip). The `org_id` resolution uses `getattr` to safely handle both internal and external args namespaces.

4. **Preserve backward compatibility for Phase 5** — Phase 6 will iterate over `projects` list. For now, Phase 5 uses the first project from the enumerated list to maintain the existing single-project discovery flow:
   ```python
   # Phase 5: use first project for single-project discovery (Phase 6 adds multi-project)
   # The project list is curated with API availability; use first project's ID
   active_project = projects[0].project_id

   # Get all available regions
   print("Fetching available regions...")
   all_regions = get_all_gcp_regions()
   print(f"Found {len(all_regions)} available regions")
   print()

   # Initialize discovery with first project
   config = GCPConfig(
       project_id=active_project,
       regions=all_regions,
       output_directory="output",
       output_format=args.format,
   )
   ```

   The rest of the function (`discovery = GCPDiscovery(config)`, etc.) stays unchanged.

5. **Update scanned_projects** — Replace `scanned_projects = discovery.get_scanned_project_ids()` with:
   ```python
   scanned_projects = [p.project_id for p in projects]
   ```
   This ensures the proof manifest and summary reflect all enumerated projects, even though Phase 5 only scans the first one. Phase 6 will make this fully functional.

**Important:** The `enumerate_gcp_projects()` call MUST be before the banner print, after `get_gcp_credential()`. This preserves the Phase 4 pattern: credential validation before banner, and now enumeration before banner too (enumeration may exit on zero projects — ENUM-02).
  </action>
  <verify>
1. `grep -n "enumerate_gcp_projects" gcp_discovery/discover.py` — function is called
2. `grep -n "ProjectInfo" gcp_discovery/discover.py` — imported
3. `grep -n "\-\-project" gcp_discovery/discover.py` — flag defined
4. `grep -n "\-\-org-id" gcp_discovery/discover.py` — flag defined
5. `grep -n "\-\-include-projects" gcp_discovery/discover.py` — flag defined
6. `grep -n "\-\-exclude-projects" gcp_discovery/discover.py` — flag defined
7. `grep -n "GOOGLE_CLOUD_ORG_ID" gcp_discovery/discover.py` — env var fallback present
8. `grep -n "projects\[0\]" gcp_discovery/discover.py` — backward compat uses first project
9. `python3 -c "import ast; ast.parse(open('gcp_discovery/discover.py').read()); print('Syntax OK')"` — no syntax errors
  </verify>
  <done>
gcp_discovery/discover.py has all four new CLI flags (--project, --org-id, --include-projects, --exclude-projects), calls enumerate_gcp_projects() before the banner, and uses the first project from the enumerated list for backward-compatible single-project discovery. The full project list is stored for Phase 6 and reflected in scanned_projects for the proof manifest.
  </done>
</task>

<task type="auto">
  <name>Task 2: Forward new GCP flags from main.py to gcp_main()</name>
  <files>main.py</files>
  <action>
Modify `main.py`:

1. **Add new GCP-specific argparse arguments** to the main parser, after the existing `--warn-sub-threshold` argument:
   ```python
   # GCP-specific arguments
   parser.add_argument(
       "--project",
       default=None,
       help="(GCP) Scan a single GCP project (bypasses enumeration).",
   )
   parser.add_argument(
       "--org-id",
       default=None,
       help="(GCP) Scope enumeration to this GCP organization ID.",
   )
   parser.add_argument(
       "--include-projects",
       nargs="+",
       metavar="PATTERN",
       default=None,
       help="(GCP) Only scan projects matching these glob patterns.",
   )
   parser.add_argument(
       "--exclude-projects",
       nargs="+",
       metavar="PATTERN",
       default=None,
       help="(GCP) Skip projects matching these glob patterns.",
   )
   ```

   The `(GCP)` prefix in help text disambiguates from Azure-specific flags (Azure uses `--subscription-workers`, etc.), matching the existing pattern where flags are provider-agnostic or clearly prefixed.

2. **Forward new args to gcp_args** in the `elif args.provider == "gcp":` block:
   ```python
   gcp_args.project = args.project
   gcp_args.org_id = args.org_id
   gcp_args.include_projects = args.include_projects
   gcp_args.exclude_projects = args.exclude_projects
   ```

   Add these after the existing `gcp_args.full = args.full` line.

**Note on `parse_known_args`:** The main parser uses `parse_known_args()` (line 257), which means unknown args are silently ignored. Adding these new flags to the main parser ensures they are properly parsed and validated (type checking, `nargs="+"` enforcement) rather than being silently dropped into the `unknown` list.
  </action>
  <verify>
1. `grep -n "\-\-project" main.py` — flag defined in main parser
2. `grep -n "\-\-org-id" main.py` — flag defined in main parser
3. `grep -n "\-\-include-projects" main.py` — flag defined in main parser
4. `grep -n "\-\-exclude-projects" main.py` — flag defined in main parser
5. `grep -n "gcp_args.project" main.py` — forwarded to gcp_args
6. `grep -n "gcp_args.org_id" main.py` — forwarded to gcp_args
7. `grep -n "gcp_args.include_projects" main.py` — forwarded to gcp_args
8. `grep -n "gcp_args.exclude_projects" main.py` — forwarded to gcp_args
9. `python3 -c "import ast; ast.parse(open('main.py').read()); print('Syntax OK')"` — no syntax errors
  </verify>
  <done>
main.py defines all four new GCP flags (--project, --org-id, --include-projects, --exclude-projects) in the main parser and forwards them to the gcp_args namespace. The flags are GCP-prefixed in help text for clarity.
  </done>
</task>

</tasks>

<verification>
1. Both `gcp_discovery/discover.py` and `main.py` parse without syntax errors
2. All four new CLI flags exist in both parsers
3. `enumerate_gcp_projects()` is called before the banner in `discover.py:main()`
4. `GOOGLE_CLOUD_ORG_ID` env var fallback is in `discover.py` (not duplicated in config.py)
5. The gcp_args namespace forwards all four new attributes
6. Backward compat: existing `python main.py gcp` with `GOOGLE_CLOUD_PROJECT` set still works (single-project path)
7. The full project list flows through to `scanned_projects` for the proof manifest
</verification>

<success_criteria>
- `--project`, `--org-id`, `--include-projects`, `--exclude-projects` flags work in both entry points
- `enumerate_gcp_projects()` is called with all required parameters
- Single-project backward compat preserved (Phase 5 uses first project from list)
- Project list is available for Phase 6 to iterate
- Both files have no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-gcp-project-enumeration/05-02-SUMMARY.md`
</output>
