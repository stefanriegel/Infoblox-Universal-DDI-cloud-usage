---
phase: 06-concurrent-multi-project-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gcp_discovery/gcp_discovery.py
autonomous: true
requirements:
  - EXEC-01
  - EXEC-02

must_haves:
  truths:
    - "GCPDiscovery accepts an optional shared_compute_clients dict and uses those clients instead of creating new ones"
    - "When shared_compute_clients is provided, a fresh dns.Client is still created per GCPDiscovery instance using the instance's project_id"
    - "When shared_compute_clients is NOT provided, the existing _init_gcp_clients() path runs unchanged (backward compatibility)"
  artifacts:
    - path: "gcp_discovery/gcp_discovery.py"
      provides: "GCPDiscovery with shared_compute_clients injection and per-instance dns.Client"
      contains: "shared_compute_clients"
  key_links:
    - from: "gcp_discovery/gcp_discovery.py"
      to: "gcp_discovery/config.py"
      via: "get_gcp_credential() called for dns.Client credential when shared_compute_clients provided"
      pattern: "get_gcp_credential"
---

<objective>
Add shared compute client injection to GCPDiscovery so that the Phase 6 worker loop can share
project-agnostic compute clients across all project workers while creating a fresh dns.Client per
worker.

Purpose: Compute API clients (InstancesClient, SubnetworksClient, etc.) are project-agnostic and
thread-safe for concurrent reads. Sharing them avoids creating 6 * N gRPC channels for N projects.
dns.Client stores `project=` at construction time, so each worker must create its own.

Output: Modified `gcp_discovery/gcp_discovery.py` with backward-compatible shared client support.
</objective>

<execution_context>
@/Users/sr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-concurrent-multi-project-execution/06-RESEARCH.md
@gcp_discovery/gcp_discovery.py
@gcp_discovery/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shared_compute_clients parameter to GCPDiscovery.__init__</name>
  <files>gcp_discovery/gcp_discovery.py</files>
  <action>
Modify `GCPDiscovery.__init__` to accept an optional `shared_compute_clients: dict | None = None` parameter (use `Optional[dict]` for Python 3.9 compat).

When `shared_compute_clients is not None`:
1. Assign shared compute clients from the dict to instance attributes:
   - `self.compute_client = shared_compute_clients["instances"]`
   - `self.zones_client = shared_compute_clients["zones"]`
   - `self.networks_client = shared_compute_clients["networks"]`
   - `self.subnetworks_client = shared_compute_clients["subnetworks"]`
   - `self.addresses_client = shared_compute_clients["addresses"]`
   - `self.global_addresses_client = shared_compute_clients["global_addresses"]`
2. Create a fresh per-project `dns.Client`:
   - Import `dns` from `google.cloud` (deferred import, inside the branch)
   - Call `get_gcp_credential()` to get the validated singleton credentials
   - `self.dns_client = dns.Client(project=self.project_id, credentials=credentials)`
   - Note: `dns.Client` at v0.35.1 has no `close()` method and uses HTTP REST transport. No cleanup needed — GC handles it when GCPDiscovery goes out of scope.
3. Build the zones-by-region cache: `self._zones_by_region = self._build_zones_by_region()`

When `shared_compute_clients is None` (or not provided):
- Call `self._init_gcp_clients()` as before — no change to the existing path.

Important: `self.project_id` must be set BEFORE the shared client branch runs. Currently, `_init_gcp_clients()` sets `self.project_id`. When using shared clients, set `self.project_id` from `self.gcp_config.project_id` directly (it is always populated by GCPConfig constructor or caller). The `self.credentials` attribute should also be set from `get_gcp_credential()`.

The `__init__` method structure should be:
```python
def __init__(self, config: GCPConfig, shared_compute_clients: Optional[dict] = None):
    # ... existing DiscoveryConfig + super().__init__ ...
    self.gcp_config = config

    if shared_compute_clients is not None:
        # EXEC-02: reuse caller-provided compute clients
        # EXEC-01: create fresh dns.Client per instance
        credentials, project = get_gcp_credential()
        self.credentials = credentials
        self.project_id = config.project_id  # always set by caller in multi-project mode

        self.compute_client = shared_compute_clients["instances"]
        self.zones_client = shared_compute_clients["zones"]
        # ... etc for all 6 compute clients ...

        from google.cloud import dns
        self.dns_client = dns.Client(project=self.project_id, credentials=credentials)
        self._zones_by_region = self._build_zones_by_region()
    else:
        # Backward-compatible path: create all clients internally
        self._init_gcp_clients()
```

Do NOT modify `_init_gcp_clients()` — it remains the backward-compatible single-project path.
Do NOT modify any discovery methods (`_discover_compute_instances`, `_discover_vpc_networks`, etc.) — they already use `self.project_id` and `self.compute_client` etc.
  </action>
  <verify>
Run `python -c "from gcp_discovery.gcp_discovery import GCPDiscovery; print('import OK')"` to verify no syntax errors.

Verify the class accepts the new parameter:
`python -c "import inspect; from gcp_discovery.gcp_discovery import GCPDiscovery; sig = inspect.signature(GCPDiscovery.__init__); print(sig); assert 'shared_compute_clients' in sig.parameters"`

Grep for the new parameter:
`grep -n 'shared_compute_clients' gcp_discovery/gcp_discovery.py`
  </verify>
  <done>
GCPDiscovery.__init__ accepts optional shared_compute_clients dict. When provided, it uses shared compute clients and creates a fresh dns.Client per instance. When not provided, the existing _init_gcp_clients() path runs unchanged.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from gcp_discovery.gcp_discovery import GCPDiscovery"` succeeds (no import errors)
2. `GCPDiscovery.__init__` signature includes `shared_compute_clients` parameter with `None` default
3. Existing code that calls `GCPDiscovery(config)` without shared clients still works (backward compatibility)
4. The shared client branch creates a new `dns.Client` with `project=self.project_id` (per-instance DNS isolation)
5. The shared client branch does NOT create any compute_v1 clients (reuses caller-provided ones)
</verification>

<success_criteria>
- GCPDiscovery can be constructed with shared compute clients (EXEC-02 prep)
- Each GCPDiscovery instance creates its own dns.Client (EXEC-01 prep)
- Backward compatibility preserved for single-project callers
</success_criteria>

<output>
After completion, create `.planning/phases/06-concurrent-multi-project-execution/06-01-SUMMARY.md`
</output>
