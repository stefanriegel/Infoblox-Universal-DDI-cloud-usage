---
phase: 04-gcp-credential-chain-and-fail-fast
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - gcp_discovery/discover.py
  - gcp_discovery/gcp_discovery.py
autonomous: true
requirements:
  - CRED-02
  - CRED-03
  - CRED-05

must_haves:
  truths:
    - "discover.py main() calls get_gcp_credential() on the main thread before constructing GCPDiscovery — credential singleton is warmed before any worker thread spawns"
    - "check_gcloud_version() and check_gcp_credentials() functions are deleted from discover.py — no gcloud subprocess calls remain"
    - "The subprocess and re imports are removed from discover.py"
    - "GCPDiscovery._init_gcp_clients() does not wrap get_gcp_credential() in bare except Exception — auth exceptions propagate"
    - "If credentials fail, the tool exits before printing 'Discovery completed successfully!' — the banner is never reached on auth failure"
  artifacts:
    - path: "gcp_discovery/discover.py"
      provides: "Clean GCP discovery entry point that warms credential singleton before workers"
    - path: "gcp_discovery/gcp_discovery.py"
      provides: "GCPDiscovery class with typed exception handling in _init_gcp_clients()"
  key_links:
    - from: "gcp_discovery/discover.py:main()"
      to: "gcp_discovery/config.py:get_gcp_credential()"
      via: "explicit singleton warming call before GCPDiscovery construction"
      pattern: "get_gcp_credential\\(\\)"
    - from: "gcp_discovery/gcp_discovery.py:_init_gcp_clients()"
      to: "gcp_discovery/config.py:get_gcp_credential()"
      via: "credential retrieval (cache hit after main-thread warming)"
      pattern: "credentials, project = get_gcp_credential"
---

<objective>
Wire the credential singleton into the GCP discovery flow — remove broken gcloud subprocess checks from discover.py, warm the singleton on the main thread, and fix bare exception catches in gcp_discovery.py.

Purpose: Complete the fail-fast credential chain so the tool never reports "Discovery completed successfully!" with 0 resources due to broken credentials. Ensure the credential is warmed on the main thread (CRED-03) and that auth exceptions are never swallowed (CRED-05).

Output: Clean `discover.py` (no subprocess calls, credential warmed before workers) and `gcp_discovery.py` (typed exception handling in `_init_gcp_clients()`).
</objective>

<execution_context>
@/Users/sr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-gcp-credential-chain-and-fail-fast/04-RESEARCH.md
@.planning/phases/04-gcp-credential-chain-and-fail-fast/04-CONTEXT.md
@.planning/phases/04-gcp-credential-chain-and-fail-fast/04-01-SUMMARY.md
@gcp_discovery/discover.py
@gcp_discovery/gcp_discovery.py
@gcp_discovery/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove gcloud subprocess checks and wire credential singleton in discover.py</name>
  <files>gcp_discovery/discover.py</files>
  <action>
Clean up `gcp_discovery/discover.py` to remove all gcloud subprocess calls and wire the credential singleton.

**Delete the `check_gcloud_version()` function entirely** (lines ~21-42). This function:
- Runs `gcloud --version` subprocess
- Checks for SDK version >= 300.0.0
- Exits if gcloud is not installed
This is wrong — gcloud CLI is not required for auth after the singleton change.

**Delete the `check_gcp_credentials()` function entirely** (lines ~45-76). This function:
- Runs `gcloud auth list --filter=status:ACTIVE` subprocess
- Exits if no active gcloud account found
This is wrong — checks gcloud CLI auth, not ADC.

**Remove unused imports:**
- Remove `import re` (only used by check_gcloud_version regex)
- Remove `import subprocess` (only used by the two deleted functions)

**Update the imports** to add the credential singleton:
```python
from .config import GCPConfig, get_all_gcp_regions, get_gcp_credential
```

**Rewrite `main()` to wire credential singleton** — replace the gcloud checks with the singleton call and reorder output per research recommendation (credential validation before banner):

Replace the current flow in main():
```python
# OLD:
print("GCP Cloud Discovery for Management Token Calculation")
print("=" * 55)
print(f"Output format: {args.format.upper()}")
print(f"Parallel workers: {args.workers}")
print()
check_gcloud_version()
check_gcp_credentials()
```

With:
```python
# NEW — credential validation first (fail-fast before banner):
credentials, project = get_gcp_credential()  # Exits on failure — CRED-02, CRED-03

print("GCP Cloud Discovery for Management Token Calculation")
print("=" * 55)
print(f"Output format: {args.format.upper()}")
print(f"Parallel workers: {args.workers}")
print()
```

The `get_gcp_credential()` call:
1. Validates credentials via `refresh(Request())` inside the singleton — CRED-01
2. Prints `[Auth]` log line — CRED-04
3. Pre-checks compute permissions — locked decision
4. Exits with actionable message on failure — CRED-02
5. Warms the singleton on the main thread before any workers — CRED-03

The `GCPDiscovery.__init__()` will call `get_gcp_credential()` again via `_init_gcp_clients()`, but since the singleton is already warmed, this is a cache hit.

**Update GCPConfig construction** to pass the project from the credential if the env var is not set:
```python
config = GCPConfig(
    project_id=project,  # From credential singleton; may be overridden by env var inside GCPConfig
    regions=all_regions,
    output_directory="output",
    output_format=args.format,
)
```
This ensures the project from ADC flows through to discovery even when `GOOGLE_CLOUD_PROJECT` is not set.

**Keep `--licensing` flag as-is** — the research notes it's orphaned dead code predating this project; removing dead code is out of scope for this phase.
  </action>
  <verify>
Run `python -c "from gcp_discovery.discover import main; print('discover.py loads OK')"` to verify no import errors.

Verify `check_gcloud_version` and `check_gcp_credentials` are gone: `grep -n "check_gcloud\|check_gcp_cred" gcp_discovery/discover.py` returns no matches.

Verify subprocess import is gone: `grep -n "import subprocess\|import re" gcp_discovery/discover.py` returns no matches.

Verify credential singleton is called: `grep -n "get_gcp_credential" gcp_discovery/discover.py` shows the import and the call in main().
  </verify>
  <done>
discover.py no longer calls gcloud subprocess. The credential singleton is warmed on the main thread before GCPDiscovery construction. Auth failures exit before the discovery banner is printed. The `subprocess` and `re` imports are removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix bare except Exception in GCPDiscovery._init_gcp_clients()</name>
  <files>gcp_discovery/gcp_discovery.py</files>
  <action>
Update `GCPDiscovery._init_gcp_clients()` in `gcp_discovery/gcp_discovery.py` to stop wrapping `get_gcp_credential()` in bare `except Exception`.

**Current code (lines 58-82):**
```python
def _init_gcp_clients(self):
    try:
        credentials, project = get_gcp_credential()
        # ... client initialization ...
        self._zones_by_region = self._build_zones_by_region()
    except Exception as e:
        raise Exception(f"Failed to initialize GCP clients: {e}")
```

The bare `except Exception` wraps BOTH the credential call AND the client initialization. This means:
- `DefaultCredentialsError` from `get_gcp_credential()` gets wrapped as `Exception("Failed to initialize GCP clients: ...")` — loses type information
- `RefreshError` gets the same treatment
- After Plan 01, `get_gcp_credential()` already calls `sys.exit(1)` on auth failure, so the credential exceptions will never reach this catch. But CRED-05 requires we eliminate bare catches on the credential path as defense-in-depth.

**Replace with structured exception handling:**

```python
def _init_gcp_clients(self):
    """Initialize GCP clients for different services."""
    # Auth exceptions (DefaultCredentialsError, RefreshError) propagate from
    # get_gcp_credential() — the singleton exits on failure, so they never
    # reach here in practice. No bare except wrapping the credential call.
    credentials, project = get_gcp_credential()

    from google.cloud import compute_v1, dns

    self.credentials = credentials
    self.project_id = project or self.gcp_config.project_id

    try:
        # Initialize compute clients (project-agnostic, shared)
        self.compute_client = compute_v1.InstancesClient(credentials=credentials)
        self.zones_client = compute_v1.ZonesClient(credentials=credentials)
        self.networks_client = compute_v1.NetworksClient(credentials=credentials)
        self.subnetworks_client = compute_v1.SubnetworksClient(credentials=credentials)
        self.addresses_client = compute_v1.AddressesClient(credentials=credentials)
        self.global_addresses_client = compute_v1.GlobalAddressesClient(credentials=credentials)

        # DNS client requires per-project instantiation
        self.dns_client = dns.Client(project=self.project_id, credentials=credentials)

        # Cache zone names so we don't guess region-a/b/c.
        self._zones_by_region = self._build_zones_by_region()
    except Exception as e:
        raise RuntimeError(f"Failed to initialize GCP clients: {e}") from e
```

Key changes:
1. `get_gcp_credential()` call is OUTSIDE the try/except block — auth exceptions propagate freely (CRED-05)
2. Client construction is inside try/except — non-auth failures (gRPC errors, import failures) are caught and re-raised as `RuntimeError` with `from e` for proper exception chaining
3. The re-raised exception uses `RuntimeError` not bare `Exception` — slightly more specific
4. `from e` preserves the original traceback for debugging

**Also update the import** at the top of the file: verify that `get_gcp_credential` is imported from `.config`. The current import on line 18 already does this:
```python
from .config import GCPConfig, get_gcp_credential
```
This is correct — no change needed.
  </action>
  <verify>
Run `python -c "from gcp_discovery.gcp_discovery import GCPDiscovery; print('gcp_discovery.py loads OK')"` to verify no import errors.

Verify the credential call is outside the try/except: `grep -n -A2 "def _init_gcp_clients" gcp_discovery/gcp_discovery.py` should show `get_gcp_credential()` before any `try:` block.

Verify no bare `except Exception` wraps the credential call: the `try:` block should start AFTER `credentials, project = get_gcp_credential()`.
  </verify>
  <done>
`_init_gcp_clients()` no longer wraps `get_gcp_credential()` in a bare `except Exception`. Auth exceptions propagate freely. Client construction failures are caught separately and re-raised with proper exception chaining.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from gcp_discovery.discover import main"` succeeds
2. `python -c "from gcp_discovery.gcp_discovery import GCPDiscovery"` succeeds
3. `grep -rn "subprocess" gcp_discovery/discover.py` returns no matches
4. `grep -rn "check_gcloud_version\|check_gcp_credentials" gcp_discovery/discover.py` returns no matches
5. `grep -n "get_gcp_credential" gcp_discovery/discover.py` shows import and call in main()
6. In `gcp_discovery/gcp_discovery.py`, `get_gcp_credential()` call is NOT inside a `try:` block — verified by reading `_init_gcp_clients()`
7. Running `python main.py gcp --check-auth` still works (main.py _check_gcp_auth is untouched)
</verification>

<success_criteria>
- check_gcloud_version() and check_gcp_credentials() deleted from discover.py
- subprocess and re imports removed from discover.py
- get_gcp_credential() called on main thread in discover.py before GCPDiscovery construction
- Credential validation happens before the discovery banner is printed
- _init_gcp_clients() does not wrap get_gcp_credential() in bare except Exception
- Auth failures exit the tool before "Discovery completed successfully!" is ever printed
</success_criteria>

<output>
After completion, create `.planning/phases/04-gcp-credential-chain-and-fail-fast/04-02-SUMMARY.md`
</output>
