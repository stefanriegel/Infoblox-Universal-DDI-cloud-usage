name: CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  # Step 1: Test setup scripts work on all platforms
  setup-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Test setup script (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "4" | bash setup_venv.sh
        source venv/bin/activate
        python -c "import sys; print(f'Python {sys.version}'); print('Virtual environment created successfully')"
    - name: Test setup script (Windows)
      if: runner.os == 'Windows'
      run: |
        & .\setup_venv.ps1 -ProviderChoice "4"
        & venv\Scripts\Activate.ps1
        python -c "import sys; print(f'Python {sys.version}'); print('Virtual environment created successfully')"

  # Step 2: Lint and format check (only on Ubuntu to save time)
  lint:
    runs-on: ubuntu-latest
    needs: setup-test
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install linting tools
      run: pip install flake8 black
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv
    - name: Format with black
      run: black --check --diff --exclude=venv .

  # Step 3: Unit tests with pytest
  unit-test:
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "4" | bash setup_venv.sh
        source venv/bin/activate
        pip install pytest
    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        & .\setup_venv.ps1 -ProviderChoice "4"
        & venv\Scripts\Activate.ps1
        pip install pytest
    - name: Run unit tests (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        source venv/bin/activate
        pytest -v
    - name: Run unit tests (Windows)
      if: runner.os == 'Windows'
      run: |
        & venv\Scripts\Activate.ps1
        pytest -v

  # Step 4: Integration tests with real cloud credentials
  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    
    strategy:
      matrix:
        provider: [aws, azure, gcp]

    # Set environment variables at the job level for all steps
    env:
      # AWS credentials
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
      # Azure credentials
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      # GCP credentials (project will be set in the step)
      GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
